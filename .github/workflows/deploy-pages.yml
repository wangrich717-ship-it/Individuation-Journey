name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install pnpm
        run: npm install -g pnpm@10.4.1

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        shell: bash
        run: |
          set -e
          REPO_NAME="${GITHUB_REPOSITORY#*/}"
          echo "Repository: $GITHUB_REPOSITORY"
          echo "Repository name: $REPO_NAME"
          echo "Base path: /$REPO_NAME/"
          pnpm exec vite build --base="/$REPO_NAME/"

      - name: Fix ALL absolute resource paths
        shell: bash
        run: |
          set -e
          python3 - <<'PY'
          import os, re

          repo = os.environ["GITHUB_REPOSITORY"].split("/", 1)[1]
          base = f"/{repo}/"
          out_root = "dist/public"

          if not os.path.isdir(out_root):
            raise SystemExit(f"Missing build output: {out_root}")

          # 需要修复的所有路径前缀
          paths_to_fix = [
            "/audio",
            "/imagery",
            "/复原主卡",
            "/动物卡",
          ]

          exts = (".js", ".css", ".html", ".map")
          patched = 0

          def fix_paths_in_text(text):
              """修复文本中的所有绝对路径"""
              new_text = text
              
              for path_prefix in paths_to_fix:
                  # 1. 修复字符串字面量: "/audio" 或 '/audio'
                  new_text = re.sub(
                      rf'(["\']){re.escape(path_prefix)}\b',
                      rf'\1{base}{path_prefix[1:]}',  # path_prefix[1:] 去掉开头的 /
                      new_text
                  )
                  
                  # 2. 修复模板字符串: `/audio/` 或 `/audio`
                  new_text = re.sub(
                      rf'`{re.escape(path_prefix)}',
                      f'`{base}{path_prefix[1:]}',
                      new_text
                  )
                  
                  # 3. 修复字符串拼接: "/audio/" + ... 或 "/audio" + ...
                  new_text = re.sub(
                      rf'(["\']){re.escape(path_prefix)}/?"\s*\+',
                      rf'\1{base}{path_prefix[1:]}/" +',
                      new_text
                  )
                  
                  # 4. 修复 URL 中的路径（如 src="/audio/..."）
                  new_text = re.sub(
                      rf'(src|href|url\(["\']?){re.escape(path_prefix)}',
                      rf'\1{base}{path_prefix[1:]}',
                      new_text
                  )
                  
                  # 5. 修复 JSON 字符串中的路径
                  new_text = re.sub(
                      rf':\s*["\']{re.escape(path_prefix)}',
                      f': "{base}{path_prefix[1:]}',
                      new_text
                  )

              return new_text

          for dirpath, _, filenames in os.walk(out_root):
              for fn in filenames:
                  if not fn.endswith(exts):
                      continue
                  p = os.path.join(dirpath, fn)
                  try:
                      with open(p, "rb") as f:
                          data = f.read()
                      text = data.decode("utf-8")
                  except Exception as e:
                      print(f"Skipping {p}: {e}")
                      continue

                  new_text = fix_paths_in_text(text)

                  if new_text != text:
                      with open(p, "wb") as f:
                          f.write(new_text.encode("utf-8"))
                      patched += 1

          print(f"✅ Fixed paths with base: {base}")
          print(f"✅ Patched {patched} files")
          PY

      - name: SPA fallback + disable Jekyll
        shell: bash
        run: |
          cp dist/public/index.html dist/public/404.html
          touch dist/public/.nojekyll

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist/public

  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy
        id: deployment
        uses: actions/deploy-pages@v4
